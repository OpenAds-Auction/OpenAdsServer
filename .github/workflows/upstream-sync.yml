name: Upstream Per-PR Sync
on:
  schedule:
    - cron: '0 6 * * 1-5'   # Weekdays at 6 AM UTC
  workflow_dispatch:          # Manual trigger

env:
  FORK_REPO: OpenAds-Auction/OpenAdsServer
  STATE_TAG: upstream-sync/last-processed

jobs:
  sync:
    runs-on: ubuntu-22.04
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.SYNC_APP_ID }}
          private-key: ${{ secrets.SYNC_APP_PRIVATE_KEY }}
          owner: OpenAds-Auction
          repositories: OpenAdsServer

      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}

      - name: Configure git
        run: |
          git config user.name "openads-sync-bot"
          git config user.email "openads-sync@thetradedesk.com"

      - name: Fetch upstream (prebid/prebid-server master)
        run: |
          git remote add upstream https://github.com/prebid/prebid-server.git
          git fetch upstream master --no-tags
          git fetch origin --tags

      - name: Cherry-pick each upstream PR
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        shell: bash
        run: |
          # Don't use set -e — we handle errors per-commit instead of aborting
          set -uo pipefail

          # Read last-synced SHA from tag (or fall back to merge-base)
          if git rev-parse "$STATE_TAG" >/dev/null 2>&1; then
            LAST_SHA=$(git rev-parse "$STATE_TAG")
            echo "Resuming from tag $STATE_TAG: $LAST_SHA"
          else
            LAST_SHA=$(git merge-base HEAD upstream/master)
            echo "No state tag found — using merge-base: $LAST_SHA"
          fi

          UPSTREAM_HEAD=$(git rev-parse upstream/master)

          if [ "$LAST_SHA" = "$UPSTREAM_HEAD" ]; then
            echo "✅ No new upstream commits."
            exit 0
          fi

          # List merge/squash commits (first-parent gives us one commit per merged PR)
          COMMITS=$(git rev-list --first-parent --reverse "${LAST_SHA}..${UPSTREAM_HEAD}")
          COMMIT_COUNT=$(echo "$COMMITS" | wc -w)
          echo "Found $COMMIT_COUNT new upstream commits"

          LATEST_GOOD_SHA="$LAST_SHA"
          CREATED=0
          SKIPPED=0
          FAILED=0

          for SHA in $COMMITS; do
            MSG=$(git log -1 --format='%s' "$SHA")
            echo ""
            echo "━━━ Processing: ${SHA:0:8} — $MSG ━━━"

            # Extract upstream PR number from commit message: "... (#1234)"
            PR_NUM=$(echo "$MSG" | grep -oP '#\K\d+' | tail -1 || true)
            if [ -z "$PR_NUM" ]; then
              echo "  ⚠ Could not extract PR number, using commit SHA as identifier"
              PR_NUM="commit-${SHA:0:8}"
            fi

            BRANCH="sync/upstream-pr-${PR_NUM}"

            # Skip if a PR already exists for this branch
            EXISTING=$(gh pr list --repo "$FORK_REPO" --head "$BRANCH" --state all --json number --jq 'length')
            if [ "$EXISTING" -gt 0 ]; then
              echo "  ⏭ PR already exists for $BRANCH, skipping"
              LATEST_GOOD_SHA="$SHA"
              SKIPPED=$((SKIPPED + 1))
              continue
            fi

            # Always start from a clean main
            git checkout main
            git branch -D "$BRANCH" 2>/dev/null || true
            git checkout -b "$BRANCH"

            # Attempt cherry-pick
            HAS_CONFLICT=false
            CHERRY_PICK_RESULT=0
            git cherry-pick "$SHA" --no-edit 2>/dev/null || CHERRY_PICK_RESULT=$?

            if [ "$CHERRY_PICK_RESULT" -ne 0 ]; then
              # Check if this is an empty cherry-pick (e.g., reverting a change
              # that was never applied, or a change already present on main)
              if git diff --cached --quiet 2>/dev/null && git diff --quiet 2>/dev/null; then
                echo "  ⏭ Empty cherry-pick (no diff against main) — skipping"
                git cherry-pick --abort 2>/dev/null || true
                git checkout main
                LATEST_GOOD_SHA="$SHA"
                SKIPPED=$((SKIPPED + 1))
                continue
              fi

              HAS_CONFLICT=true
              echo "  ⚠ Cherry-pick conflict — creating draft PR"
              git add -A
              git commit --no-edit -m "Upstream PR #${PR_NUM}: ${MSG} (CONFLICTS)" || true
            fi

            # Check if there are actually any commits to push
            # (handles edge case where cherry-pick produced nothing)
            if [ "$(git rev-parse HEAD)" = "$(git rev-parse main)" ]; then
              echo "  ⏭ No changes vs main after cherry-pick — skipping"
              git checkout main
              LATEST_GOOD_SHA="$SHA"
              SKIPPED=$((SKIPPED + 1))
              continue
            fi

            # Skip if the only changes are to .github/workflows/ (upstream CI, not relevant to fork)
            CHANGED_FILES=$(git diff --name-only main)
            NON_WORKFLOW_FILES=$(echo "$CHANGED_FILES" | grep -v '^\.github/workflows/' || true)
            if [ -z "$NON_WORKFLOW_FILES" ]; then
              echo "  ⏭ Only workflow files changed — skipping"
              git checkout main
              LATEST_GOOD_SHA="$SHA"
              SKIPPED=$((SKIPPED + 1))
              continue
            fi

            git push origin "$BRANCH" --force

            # Build PR body
            PR_TITLE="Upstream PR #${PR_NUM}: ${MSG}"
            PR_BODY="Cherry-picked from upstream [\`${SHA:0:8}\`](https://github.com/prebid/prebid-server/commit/${SHA})"
            if [[ "$PR_NUM" != commit-* ]]; then
              PR_BODY="${PR_BODY}
          Original PR: https://github.com/prebid/prebid-server/pull/${PR_NUM}"
            fi

            # Create PR
            DRAFT_FLAG=""
            if [ "$HAS_CONFLICT" = true ]; then
              DRAFT_FLAG="--draft"
            fi

            PR_URL=$(gh pr create \
              --repo "$FORK_REPO" \
              --title "$PR_TITLE" \
              --body "$PR_BODY" \
              --head "$BRANCH" \
              --base main \
              $DRAFT_FLAG 2>&1) || {
                echo "  ❌ Failed to create PR: $PR_URL"
                git checkout main
                LATEST_GOOD_SHA="$SHA"
                FAILED=$((FAILED + 1))
                continue
              }

            echo "  ✅ Created PR: $PR_URL"

            # Add labels (non-fatal)
            gh pr edit "$PR_URL" --repo "$FORK_REPO" --add-label "upstream-sync" || echo "  ⚠ Could not add upstream-sync label"
            if [ "$HAS_CONFLICT" = true ]; then
              gh pr edit "$PR_URL" --repo "$FORK_REPO" --add-label "merge-conflict" || echo "  ⚠ Could not add merge-conflict label"
            fi

            LATEST_GOOD_SHA="$SHA"
            CREATED=$((CREATED + 1))
            git checkout main
          done

          echo ""
          echo "━━━ Summary ━━━"
          echo "  Created: $CREATED"
          echo "  Skipped: $SKIPPED"
          echo "  Failed:  $FAILED"

          # Update state tag (force-push to move the tag to the latest processed SHA)
          if [ "$LATEST_GOOD_SHA" != "$LAST_SHA" ]; then
            git tag -f "$STATE_TAG" "$LATEST_GOOD_SHA"
            git push origin "$STATE_TAG" --force
            echo "Updated state tag $STATE_TAG → ${LATEST_GOOD_SHA:0:8}"
          fi
