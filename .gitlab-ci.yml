workflow:
  rules:
    - if: $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS && $CI_PIPELINE_SOURCE == "merge_request_event"
      when: never
    - if: $CI_COMMIT_BRANCH # execute a branch pipline when there isn't a merge request

image: docker.pkgs.adsrvr.org/ttd-pipeline-prod/ttd-pipeline/dotnet/core/sdk-8.0.301-dev-infra:1.2.7

default:
  id_tokens:
    KUBEINFO_ID_TOKEN:
      aud: kubeinfo.adsrvr.net
    DEVINFRA_VAULT_ID_TOKEN:
      aud: https://vault.adsrvr.org
    SPIFFE_GITLAB_ID_TOKEN:
      aud: https://spire.prod.adsrvr.net

include:
  - project: thetradedesk/teams/devacc/TTD.DevInfra
    file:
      - GitlabShared/gitlab-ci-cloudsmith.yml
    ref: master

variables:
  APP: ttd-auction-server
  AUCTION_SERVER_MAIN: ttd-auction-server-main

stages:
  - build

build:
  stage: build
  services:
    - name: ${CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX}/docker:28.3.3-dind@sha256:c0872aae4791ff427e6eda52769afa04f17b5cf756f8267e0d52774c99d5c9de
      alias: docker
  script:
    - !reference [.fetch-cloudsmith-token, script]
    - |
      if [[ "${CI_COMMIT_BRANCH}" == "${AUCTION_SERVER_MAIN}" ]]
      then
        export PUSH_DOCKER_REGISTRY=${DOCKER_PRODUCTION_CLOUDSMITH}
      else
        export PUSH_DOCKER_REGISTRY=${DOCKER_DEV_CLOUDSMITH}
      fi
    - |
      DEFAULT_IMAGE=${APP}:latest
      # Build and capture output to extract public key
      docker build --platform linux/amd64 -t ${PUSH_DOCKER_REGISTRY}/${DEFAULT_IMAGE} . 2>&1 | tee build.log
      
      # Extract public key from build output
      mkdir -p artifacts
      awk '/=== BUILD ATTESTATION PUBLIC KEY ===/,/=== END PUBLIC KEY ===/' build.log | \
        grep -v "=== BUILD ATTESTATION PUBLIC KEY ===" | \
        grep -v "=== END PUBLIC KEY ===" > artifacts/build_key.pub
      
      # Extract signature and payload for completeness
      awk '/=== BUILD SIGNATURE \(BASE64\) ===/,/=== END SIGNATURE ===/' build.log | \
        grep -v "=== BUILD SIGNATURE (BASE64) ===" | \
        grep -v "=== END SIGNATURE ===" > artifacts/build_signature.txt
      
      awk '/=== SIGNATURE PAYLOAD \(PLAINTEXT\) ===/,/=== END PAYLOAD ===/' build.log | \
        grep -v "=== SIGNATURE PAYLOAD (PLAINTEXT) ===" | \
        grep -v "=== END PAYLOAD ===" > artifacts/build_payload.txt
      
      # Extract verification info
      awk '/=== VERIFICATION INFO ===/,/=== END VERIFICATION INFO ===/' build.log | \
        grep -v "=== VERIFICATION INFO ===" | \
        grep -v "=== END VERIFICATION INFO ===" > artifacts/verification_info.txt
      
      # Create a comprehensive attestation file
      PUBLIC_KEY=$(cat artifacts/build_key.pub | tr -d '\n' | sed 's/"/\\"/g')
      SIGNATURE=$(cat artifacts/build_signature.txt | tr -d '\n')
      PAYLOAD=$(cat artifacts/build_payload.txt | tr -d '\n')
      VERIFICATION_INFO=$(cat artifacts/verification_info.txt | tr -d '\n')
      COMMIT_HASH=$(git rev-parse HEAD)
      BUILD_TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
      
      cat > artifacts/build_attestation.json << EOF
      {
        "public_key": "${PUBLIC_KEY}",
        "signature": "${SIGNATURE}",
        "payload": "${PAYLOAD}",
        "verification_info": "${VERIFICATION_INFO}",
        "commit_hash": "${COMMIT_HASH}",
        "build_timestamp": "${BUILD_TIMESTAMP}"
      }
      EOF
      
      docker push --all-tags ${PUSH_DOCKER_REGISTRY}/${APP}
  artifacts:
    name: "build-attestation-${CI_COMMIT_SHORT_SHA}"
    paths:
      - artifacts/
    expire_in: 30 days
  rules:
    - if: '$CI_COMMIT_BRANCH != $AUCTION_SERVER_MAIN'
      when: manual
      allow_failure: true
    - if: '$CI_COMMIT_BRANCH == $AUCTION_SERVER_MAIN'
      when: always